package nl.rijksoverheid.rdw.rde.client.activities;

import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;

import android.app.PendingIntent;
import android.content.Intent;
import android.nfc.NfcAdapter;
import android.nfc.Tag;
import android.os.Bundle;
import android.provider.Settings;

import net.sf.scuba.smartcards.CardServiceException;

import org.bouncycastle.util.encoders.Base64;
import org.bouncycastle.util.encoders.Hex;
import org.jmrtd.BACKey;

import java.io.IOException;
import java.security.GeneralSecurityException;

import nl.rijksoverheid.rdw.rde.client.R;
import nl.rijksoverheid.rdw.rde.client.lib.AndroidRdeDocument;
import nl.rijksoverheid.rdw.rde.documents.*;
import nl.rijksoverheid.rdw.rde.messaging.*;
import nl.rijksoverheid.rdw.rde.mrtdfiles.Dg14Reader;

public class TestRdeDecryptionActivity extends AppCompatActivity
{
    ActivityResultLauncher<Intent> nfcSettingsLauncher;

    @Override
    protected void onCreate(@Nullable final Bundle savedInstanceState)
    {
        nfcSettingsLauncher = registerForActivityResult(new ActivityResultContracts.StartActivityForResult(), result ->
        {
            // nothing to do
        });

        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_enrollment_read_document);
    }

    @Override
    protected void onNewIntent(final Intent intent)
    {
        if (intent == null)
            throw new IllegalArgumentException();

        super.onNewIntent(intent);

        if (!NfcAdapter.ACTION_TECH_DISCOVERED.equals(intent.getAction()))
            return;

        final Tag tag = intent.getExtras().getParcelable(NfcAdapter.EXTRA_TAG);

        if (tag == null)
            throw new IllegalStateException("Test failed. No NfcAdaptor Tag.");

        final String DOCUMENT_NUMBER = "SPECI2014";
        final String DATE_OF_BIRTH = "650310";
        final String DATE_OF_EXPIRY = "240309";
        final var SPEC2014BacKey = new BACKey(DOCUMENT_NUMBER,DATE_OF_BIRTH,DATE_OF_EXPIRY);

        //From SPEC2014
        //final var HexEncodedDg14 = "6E8201D9318201D5300D060804007F0007020202020101300F060A04007F000702020302040201013012060A04007F0007020204020402010202010E30170606678108010105020101060A04007F0007010104010330820184060904007F000702020102308201753082011D06072A8648CE3D020130820110020101303406072A8648CE3D0101022900D35E472036BC4FB7E13C785ED201E065F98FCFA6F6F40DEF4F92B9EC7893EC28FCD412B1F1B32E27305404283EE30B568FBAB0F883CCEBD46D3F3BB8A2A73513F5EB79DA66190EB085FFA9F492F375A97D860EB40428520883949DFDBC42D3AD198640688A6FE13F41349554B49ACC31DCCD884539816F5EB4AC8FB1F1A604510443BD7E9AFB53D8B85289BCC48EE5BFE6F20137D10A087EB6E7871E2A10A599C710AF8D0D39E2061114FDD05545EC1CC8AB4093247F77275E0743FFED117182EAA9C77877AAAC6AC7D35245D1692E8EE1022900D35E472036BC4FB7E13C785ED201E065F98FCFA5B68F12A32D482EC7EE8658E98691555B44C5931102010103520004710DA6DAB5B770920D3D4D6807B02A13059BEFB4926E2D00CFDE4B4471571473A582934BBE92059800663578C83419E3563FE3E8AF3AE58B521D3741693C9CE19B312392CB00F59AF086863186706396";
        final var CaProtocolOid = "0.4.0.127.0.7.2.2.3.2.4";

        //From C#

//        Z        : 308201753082011d06072a8648ce3d020130820110020101303406072a8648ce3d0101022900d35e472036bc4fb7e13c785ed201e065f98fcfa6f6f40def4f92b9ec7893ec28fcd412b1f1b32e27305404283ee30b568fbab0f883ccebd46d3f3bb8a2a73513f5eb79da66190eb085ffa9f492f375a97d860eb40428520883949dfdbc42d3ad198640688a6fe13f41349554b49acc31dccd884539816f5eb4ac8fb1f1a604510443bd7e9afb53d8b85289bcc48ee5bfe6f20137d10a087eb6e7871e2a10a599c710af8d0d39e2061114fdd05545ec1cc8ab4093247f77275e0743ffed117182eaa9c77877aaac6ac7d35245d1692e8ee1022900d35e472036bc4fb7e13c785ed201e065f98fcfa5b68f12a32d482ec7ee8658e98691555b44c59311020101035200046beb106d11680f9650ef6e21aa14bfc07ec6d9c7bb37a26da026dbaca9ea6e2c31b6c86e6cadb7e09e4ef61ac2d10494b481c1663a3de2a1e19d4b293e9f29429d5a375f62714c10f465c7889869e120
//        File Id  : 14
//        Read Len : 255
//        Content  : 6E8201D9318201D5300D060804007F0007020202020101300F060A04007F000702020302040201013012060A04007F0007020204020402010202010E30170606678108010105020101060A04007F0007010104010330820184060904007F000702020102308201753082011D06072A8648CE3D020130820110020101303406072A8648CE3D0101022900D35E472036BC4FB7E13C785ED201E065F98FCFA6F6F40DEF4F92B9EC7893EC28FCD412B1F1B32E27305404283EE30B568FBAB0F883CCEBD46D3F3BB8A2A73513F5EB79DA66190EB085FFA9F492F375A97D860EB40428520883949DFDBC42D3AD198640688A6FE13F41349554B49ACC31DCCD884539816F5EB4AC8FB1F1A604510443BD7E9AFB53D8B85289BCC48EE5BFE6F20137D10A087EB6E7871E2A10A599C710AF8D0D39E2061114FDD05545EC1CC8AB4093247F77275E0743FFED117182EAA9C77877AAAC6AC7D35245D1692E8EE1022900D35E472036BC4FB7E13C785ED201E065F98FCFA5B68F12A32D482EC7EE8658E98691555B44C5931102010103520004710DA6DAB5B770920D3D4D6807B02A13059BEFB4926E2D00CFDE4B4471571473A582934BBE92059800663578C83419E3563FE3E8AF3AE58B521D3741693C9CE19B312392CB00F59AF086863186706396
//        Command  : 0cb08e000d9701ff8e08f8872b65f0b1cdfc00
//        Response : 87820101016cae3bc8e7527664405cbfa69b263b727fd40916c3c32dd93c7f8030e37949eda6434b053426174e8c0cd3fc1b1b6f1fa255a6c02389ebf1eb365dbe995bebbdf17b283fb3bc68e7ad5613a042615c726bc908e1523d03ebfd1e48865dab4cc4b91cc65fde68378454bcf981749e36b1e4b51ae5d276e76ddee679a4c5927a368f79d49dcaae9bea17476c12885321316be5c5c173546da5f2b551fdd2913874747f41f46607b2d2212e527859b006156c78599220c3bbd9a8bc26acfe568717aed2c464392bcc0eb9c57f81ff5a226be956121def3e10a05e620047fcb39a24743d1e3ae1b6cbfe7fc85ebfeee7d6c4f51a7add7e6a131a643cdd0d798c9374990290008e0857ab486fd71c6d2c9000
//        final var hexPublicKey = "308201753082011D06072A8648CE3D020130820110020101303406 072A8648CE3D0101022900D35E472036BC4FB7E13C785ED201E065F98FCFA6F6F40DEF4F92B9EC7893EC28FCD412B1F1B32E27305404283EE30B568FBAB0F883CCEBD46D3F3BB8A2A73513F5EB79DA66190EB085FFA9F492F375A97D860EB40428520883949DFDBC42D3AD198640688A6FE13F41349554B49ACC31DCCD884539816F5EB4AC8FB1F1A604510443BD7E9AFB53D8B85289BCC48EE5BFE6F20137D10A087EB6E7871E2A10A599C710AF8D0D39E2061114FDD05545EC1CC8AB4093247F77275E0743FFED117182EAA9C77877AAAC6AC7D35245D1692E8EE1022900D35E472036BC4FB7E13C785ED201E065F98FCFA5B68F12A32D482EC7EE8658E98691555B44C5931102010103520004C5717E463920D4B56899C172E3FF76006C6F70C1AE56A53D3D71171EEAD1DF8161E751DD91EED21E767FF2E2E209B37C7D3ACCA5C45EBE46CA7BB6BBE939CDE307119AEC51F5191D01C626D5F45D80A6";
//        final var hexExpectedCommand = "0CB08E000D9701408E08BFE13DD1749D820300";
//        final var hexExpectedWrappedRbResult = "875101C6D29F7048C951702B55977CC348C3DA7A6C6DA01464B0E79E7181613BEAC91D054C03AA7D345ED50FA42F837A73DA79D404140332A5C3418832CFFDC64D9FDFD9D624D0BD76DF16C9E303E39A8BA03C990290008E089AC7604053B256619000";


//Case 2
//        DUMP RDE Message Parameters >>>>>>>
//        {
//            "EphemeralPublicKey": "MIIBdTCCAR0GByqGSM49AgEwggEQAgEBMDQGByqGSM49AQECKQDTXkcgNrxPt+E8eF7SAeBl+Y/Ppvb0De9PkrnseJPsKPzUErHxsy4nMFQEKD7jC1aPurD4g8zr1G0/O7iipzUT9et52mYZDrCF/6n0kvN1qX2GDrQEKFIIg5Sd/bxC060ZhkBoim/hP0E0lVS0mswx3M2IRTmBb160rI+x8aYEUQRDvX6a+1PYuFKJvMSO5b/m8gE30QoIfrbnhx4qEKWZxxCvjQ054gYRFP3QVUXsHMirQJMkf3cnXgdD/+0RcYLqqcd4d6qsasfTUkXRaS6O4QIpANNeRyA2vE+34Tx4XtIB4GX5j8+lto8Soy1ILsfuhljphpFVW0TFkxECAQEDUgAEgVtsBHw3sbVWXnf+w2BZJ5fpaCkHqlSFjozYjhsoXZm63SdfQj7VC70BpDP9EumpuMkfNA505B28Dkv/d4SJY6oUl0s2aGL7iL4EhIoiOkM=",
//            "WrappedCommand": "DLCOAA2XAf+OCF+/orVtnCZyAA==",
//            "WrappedResponse": "h4IBAQFXuPLhPKTSAau7r3Vs34+XbojwfaKp2+95TDxmcn9yFsn899Zer6tU4A3925yF8OA9WuJZ45WO+Oe34i54piGExtNqSb2FMIdQWvTJ02kA7o985A68bQqX+JEr+EcZJMbk3RKGMbHqWWOlKncEuxZA8qmEAglh349mN/wTPftpmKUVmVWX3XuRHqRTCGaAtx7JBHJpGODPPTU/OhUq/WcXbozHZBMY/GRyDCoTVHcx63/OvtlzLhNB8Uy3ZrUXvTNRqIxa7Uz0qUf3CACsbtND2NVS8J83kBinUBBiqngg6HiLmyNjSnNaqPNxEvHuoUi0m/enkZ8lVET/1QtE8BVfmQKQAI4IW3rPvDSTBymQAA==",
//            "DebugInfo":
//            {
//                    "SharedSecretHex": "3b58cb3b9455e9f62d1a2503ab9f19a29df1d09a5c08d0d9811f92aad49a55a7f95d6575ac95ffa3",
//                    "ReadBinaryResponseHex": "878201010157b8f2e13ca4d201abbbaf756cdf8f976e88f07da2a9dbef794c3c66727f7216c9fcf7d65eafab54e00dfddb9c85f0e03d5ae259e3958ef8e7b7e22e78a62184c6d36a49bd853087505af4c9d36900ee8f7ce40ebc6d0a97f8912bf8471924c6e4dd128631b1ea5963a52a7704bb1640f2a984020961df8f6637fc133dfb6998a515995597dd7b911ea453086680b71ec904726918e0cf3d353f3a152afd67176e8cc7641318fc64720c2a13547731eb7fcebed9732e1341f14cb766b517bd3351a88c5aed4cf4a947f70800ac6ed343d8d552f09f379018a7501062aa7820e8788b9b23634a735aa8f37112f1eea148b49bf7a7919f255444ffd50b44f0155f990290008e085b7acfbc349307299000",
//                    "CaWrapperDebugInfo":
//                    {
//                        "Type": "AesSecureMessagingWrapper",
//                        "Cipher": "AES/CBC/NoPadding",
//                        "Mac": "AESCMAC",
//                        "KsEnc": "7098d79ade35fce2e6cf09a32983a0b157ee45af704d56cc9b63f41509e13bd4",
//                        "KsMac": "06e23af5aa33217ed2af17992955b173d3c025078717ac23afd315d7442c8c01"
//                    },
//                "WrappedResponseHex": "878201010157b8f2e13ca4d201abbbaf756cdf8f976e88f07da2a9dbef794c3c66727f7216c9fcf7d65eafab54e00dfddb9c85f0e03d5ae259e3958ef8e7b7e22e78a62184c6d36a49bd853087505af4c9d36900ee8f7ce40ebc6d0a97f8912bf8471924c6e4dd128631b1ea5963a52a7704bb1640f2a984020961df8f6637fc133dfb6998a515995597dd7b911ea453086680b71ec904726918e0cf3d353f3a152afd67176e8cc7641318fc64720c2a13547731eb7fcebed9732e1341f14cb766b517bd3351a88c5aed4cf4a947f70800ac6ed343d8d552f09f379018a7501062aa7820e8788b9b23634a735aa8f37112f1eea148b49bf7a7919f255444ffd50b44f0155f990290008e085b7acfbc349307299000"
//            }
//        }
//<<<<<< DUMP RDE Message Parameters
//        SecretKey: af6d3f0a12ede851593dbeb764b91ef2825575bd60c5f781fc271dafc09f91b1
//        Hex Encoded Message: 504b0304140000080800c08afb5436623b130d0000000500000005000000525f315f3132d433d03300000000ffff0300504b0304140000080800c08afb5454eb962c19000000100000000400000041545f318a0dd0547ec7cad7bbfd4a3bbfcfdb95f600000000ffff0300504b0304140000080800c08afb5414fabdcf0c0000000400000005000000525f335f31cacb2f4905000000ffff0300504b0304140000080800c08afb548bff4c5619000000100000000400000041545f33faca18bf77068358d0d223319d3ca52cf701000000ffff0300504b0304140000080800c08afb541797ddf33f020000c703000005000000525f325f319453cb8e1c370cfc9739070b4aa444d2675f8200b17f417c050bccee18ce8e01c3f0bf87b3ce29b7a0d12d3545958ac5d28fcbf3b7cb870b6d12f0987218e9a4cdc0a580ca727695d5e5b7cbd7c8df5feb76f9f0e31237bfbfe4ebdbc7e7bfbf5ccff73fcf4b36c6c7ac73bfbe75aa9fcf5f6f6f37bf5d3f3d47afc0133dc1d398dc5f7e9afd60bfd4995f3c3edfedfaec7fe4f74e44900983d7af71046ce079a4c9796240c7fe5d81c7fcf187f49f9c8ec29c0ad01524f104dce654c639d0595646ef4cd8ab54caabcbdb451059543a4db37314d3672f068d69a386e1ccc9088b80a6602682ad2d65c7a044d03d2d6807169ac999ade11a582b8d35cede43210d64551d2dd259c8eb2887ec8ebf63ae098da3a451d16c5bfd1343bb26d8f2e840732f1a48ba1619e971c711ee21420b55c67e1c46c79b53f33d1b680d20420b4e3d650b43ac4f11357792cc6595bb1e7a720c38209cb6938547ced381a5eadc6349b4909a13f618832a029ac24a1fee729abce2242ee6c92b8109ab32c6e02133cf698c86e4738eefe3dc1d99b4626c9dd91cfe5f9f96b5e2631e9c410dee9c297b49b64a3ad65a46e44bb1adf1ee0ce8b3008064f446076247b6616bed95cc958e1b964ed616684bf368968ba401e5216b0eebae84aa9d88aead6862c602b376d821c48a315b5a35711dd52e4ca6a4d1dd8324ab56444874e3398394c9706fd9b34cc4b25951db6462033d6ecbede5e5bcbedf136f9b64d30e6518553d6fd7589dd97e0bf5b95b27e82d9176ffebd76d7cbd5faf3f7ffe030000ffff0300504b0304140000080800c08afb5402144c9619000000100000000400000041545f32329af1fe93edde69792d9925afddeda6ce05000000ffff0300504b0304140000080800c08afb54179b2e45190000001000000005000000525f355f31aa4e3514db739bfbc8bad5f3deaa7f78b613000000ffff0300504b0304140000080800c08afb5463a71195180000001000000003000000415f354a593595afe8594052b951697da1936a2f000000ffff0300504b0304140000080800c08afb542c81fa6a2a0000002000000005000000525f345f31e2bd78ba6abbb4f97cfb3f338a1f58ca7f529cb3373b304af9c9c1f46adb5b1fb23c01000000ffff0300504b0304140000080800c08afb54a4e1cd8419000000100000000400000041545f347a626cc870dc5c726ac4eb293d77b2acf701000000ffff0300504b01021400140000080800c08afb5436623b130d00000005000000050000000000000000000000000000000000525f315f31504b01021400140000080800c08afb5454eb962c190000001000000004000000000000000000000000003000000041545f31504b01021400140000080800c08afb5414fabdcf0c0000000400000005000000000000000000000000006b000000525f335f31504b01021400140000080800c08afb548bff4c56190000001000000004000000000000000000000000009a00000041545f33504b01021400140000080800c08afb541797ddf33f020000c70300000500000000000000000000000000d5000000525f325f31504b01021400140000080800c08afb5402144c96190000001000000004000000000000000000000000003703000041545f32504b01021400140000080800c08afb54179b2e451900000010000000050000000000000000000000000072030000525f355f31504b01021400140000080800c08afb5463a7119518000000100000000300000000000000000000000000ae030000415f35504b01021400140000080800c08afb542c81fa6a2a000000200000000500000000000000000000000000e7030000525f345f31504b01021400140000080800c08afb54a4e1cd84190000001000000004000000000000000000000000003404000041545f34504b0506000000000a000a00f80100006f0400000000

//        final var b64EphemeralPublicKey= "MIIBdTCCAR0GByqGSM49AgEwggEQAgEBMDQGByqGSM49AQECKQDTXkcgNrxPt+E8eF7SAeBl+Y/Ppvb0De9PkrnseJPsKPzUErHxsy4nMFQEKD7jC1aPurD4g8zr1G0/O7iipzUT9et52mYZDrCF/6n0kvN1qX2GDrQEKFIIg5Sd/bxC060ZhkBoim/hP0E0lVS0mswx3M2IRTmBb160rI+x8aYEUQRDvX6a+1PYuFKJvMSO5b/m8gE30QoIfrbnhx4qEKWZxxCvjQ054gYRFP3QVUXsHMirQJMkf3cnXgdD/+0RcYLqqcd4d6qsasfTUkXRaS6O4QIpANNeRyA2vE+34Tx4XtIB4GX5j8+lto8Soy1ILsfuhljphpFVW0TFkxECAQEDUgAEgVtsBHw3sbVWXnf+w2BZJ5fpaCkHqlSFjozYjhsoXZm63SdfQj7VC70BpDP9EumpuMkfNA505B28Dkv/d4SJY6oUl0s2aGL7iL4EhIoiOkM=";
//        final var b64WrappedCommand= "DLCOAA2XAf+OCF+/orVtnCZyAA==";
//        final var b64WrappedResponse= "h4IBAQFXuPLhPKTSAau7r3Vs34+XbojwfaKp2+95TDxmcn9yFsn899Zer6tU4A3925yF8OA9WuJZ45WO+Oe34i54piGExtNqSb2FMIdQWvTJ02kA7o985A68bQqX+JEr+EcZJMbk3RKGMbHqWWOlKncEuxZA8qmEAglh349mN/wTPftpmKUVmVWX3XuRHqRTCGaAtx7JBHJpGODPPTU/OhUq/WcXbozHZBMY/GRyDCoTVHcx63/OvtlzLhNB8Uy3ZrUXvTNRqIxa7Uz0qUf3CACsbtND2NVS8J83kBinUBBiqngg6HiLmyNjSnNaqPNxEvHuoUi0m/enkZ8lVET/1QtE8BVfmQKQAI4IW3rPvDSTBymQAA==";

//        ssc       : 0000000000000000-0000000000000001
//        n         : 0000000000000000-0000000000000001-0cb08e0080000000-0000000000000000-9701408000000000-0000000000000000
//        mac       : 8fe6caebc8348956-82a1eae8512f506d
//        d08e      : 8e088fe6caebc834-8956
//        Response       : 6e8201d9318201d5300d060804007f0007020202020101300f060a04007f000702020302040201013012060a04007f0007020204020402010202010e30170606
//        Padded response: 6e8201d9318201d5300d060804007f0007020202020101300f060a04007f000702020302040201013012060a04007f0007020204020402010202010e3017060680000000000000000000000000000000
//        IV: a579704f0a5ad1f30e2840ed04b44b1f
//        Response ciphertext: e1530b6369f09d8f666bcf3e493a348c3b637a55fef7d7bf73570cbbbb10d5250808c60d5c8d92e90fbe51e2a96cc8c81109016613ed56030d345068914d409f389e33561542c9946232e5482d0a51d2
//        MAC this: 875101e1530b6369f09d8f666bcf3e493a348c3b637a55fef7d7bf73570cbbbb10d5250808c60d5c8d92e90fbe51e2a96cc8c81109016613ed56030d345068914d409f389e33561542c9946232e5482d0a51d299029000
//        MAC     : 2b976baed53aece22d6098cc3847949c
//        DUMP RDE Message Parameters >>>>>>>
//        {
//            "EphemeralPublicKey": "MIIBdTCCAR0GByqGSM49AgEwggEQAgEBMDQGByqGSM49AQECKQDTXkcgNrxPt+E8eF7SAeBl+Y/Ppvb0De9PkrnseJPsKPzUErHxsy4nMFQEKD7jC1aPurD4g8zr1G0/O7iipzUT9et52mYZDrCF/6n0kvN1qX2GDrQEKFIIg5Sd/bxC060ZhkBoim/hP0E0lVS0mswx3M2IRTmBb160rI+x8aYEUQRDvX6a+1PYuFKJvMSO5b/m8gE30QoIfrbnhx4qEKWZxxCvjQ054gYRFP3QVUXsHMirQJMkf3cnXgdD/+0RcYLqqcd4d6qsasfTUkXRaS6O4QIpANNeRyA2vE+34Tx4XtIB4GX5j8+lto8Soy1ILsfuhljphpFVW0TFkxECAQEDUgAEvj5W85oNciW3tK/iCPhe0XXtMLnmB2jOILjQJKKHRReERjD34YZt43/hV90kW6UYL/xrvOPo+UxKIFcxv4+6ZBoCIruFyN3xAK3cY3n5e8o=",
//                "WrappedCommand": "DLCOAA2XAUCOCI/myuvINIlWAA==",
//                "WrappedResponse": "h1EB4VMLY2nwnY9ma88+STo0jDtjelX+99e/c1cMu7sQ1SUICMYNXI2S6Q++UeKpbMjIEQkBZhPtVgMNNFBokU1AnzieM1YVQsmUYjLlSC0KUdKZApAAjggrl2uu1Trs4pAA",
//                "DebugInfo": {
//            "SharedSecretHex": "0a2ee10f0dbc6e9a108d699cf1a51b267c1d6a8fd09219bcae8179f260b6b7d1cc7e446666afcfdd",
//                    "ReadBinaryResponseHex": "875101e1530b6369f09d8f666bcf3e493a348c3b637a55fef7d7bf73570cbbbb10d5250808c60d5c8d92e90fbe51e2a96cc8c81109016613ed56030d345068914d409f389e33561542c9946232e5482d0a51d2990290008e082b976baed53aece29000",
//                    "CaWrapperDebugInfo": {
//                "Type": "AesSecureMessagingWrapper",
//                        "Cipher": "AES/CBC/NoPadding",
//                        "Mac": "AESCMAC",
//                        "KsEnc": "e2b29b6b2a4dfc1fa6f2d8007d22d589a7827e5e2f44ad9ceb1ebf16142782f3",
//                        "KsMac": "4da7db957e387b01cf80e5d044d0984d2a7cf280fffe54e2ec2c8269d030fa01"
//            },
//            "WrappedResponseHex": "875101e1530b6369f09d8f666bcf3e493a348c3b637a55fef7d7bf73570cbbbb10d5250808c60d5c8d92e90fbe51e2a96cc8c81109016613ed56030d345068914d409f389e33561542c9946232e5482d0a51d2990290008e082b976baed53aece29000"
//        }
//        }
//<<<<<< DUMP RDE Message Parameters
//        SecretKey: 1edba8997375460ceff9aad08eafe0a38001911623a4ff5f4a57499df63d3929
//        Hex Encoded Message: 504b0304140000080800298efb5436623b130d0000000500000005000000525f315f3132d433d03300000000ffff0300504b0304140000080800298efb542ac491b819000000100000000400000041545f317ab4f0ee639dd22577e7a648ac90d169b205000000ffff0300504b0304140000080800298efb5414fabdcf0c0000000400000005000000525f335f31cacb2f4905000000ffff0300504b0304140000080800298efb54edf67d8719000000100000000400000041545f33ba62fbfafdc212f7d7293e97856be39e3601000000ffff0300504b0304140000080800298efb5463b2ceb640020000c703000005000000525f325f319453cb8e1c370cfc9739070b4aa444ca675f8200b17f81cf6081d91dc3d9316018fef770d639e51634baa5a628b2c82afeb83c7fbb7cb80c3bbac1b46a2d9b4c1ac555c079d8d8242ebf5dbe46fefe5ab7cb871f97b8f9fd255fdf3e3efffde5aadfffd497ec181fb3f47e7d6b57d7cf5f6f6f37bf5d3f3d479fc0133dc1d398dc5f7e9afd60bfd49e5f3c3edfedfaec7fe4f77644900983d7af75046ce0a9b2493c31a06dff9ec063fff843fa8f4f5b61ce0310b89278026e732ae31ce82c2ba36f26ec5547ca4b77ed22882caa33ed64fb1c4c9f7d1834a68d1a863327232c029a829908b6b694a94189a07b5ad00e2c34139dcab806d64ae313baf7389006b2aaf4149d59c84b0f87ecb6bfc75c133acea113158d76066a8cd335c11669888dbd68209db5c8e8a83b8e700f115a7864ec4732526f4c8db799a43580082d9a412d5b18629d458eb993642eabdcf5e827c70005e1b49d2c3c726a1bd639cebd964437f2e4843dc6a08a8086b0d287bb68833f38898b79f24a60c2aa8c3178c84cd58ed12159557dab73333269c5d8676663f87f3c2deb8e8fa938833ab873a6ec25d95d3a63b56a897c1d6c69bc2b033a17009025e6da85472178ced56a26adae47ea91a3b596d1749e6c15ed56d084563b4cd229dc4d6421da08d5a864ef48e4e66271441762babacc2adf662dbd943ae47d1116e3b07ae863d3d0ae72b62c964b44b57035c237f2a91e2dd7c7b4dc5e5ef4f57d4ebc65920d3b0ec3a0c75ea489724d734192b336405f89b4fb5fbfa6f1f57ebdfefcf90f000000ffff0300504b0304140000080800298efb549ef5ca3519000000100000000400000041545f323afb755b52aaf79bcf5d0b199938789ee603000000ffff0300504b0304140000080800298efb54cbead83b190000001000000005000000525f355f314a5c219251da1ba55bfbd76e5a58cafc2f00000000ffff0300504b0304140000080800298efb5485cc0675190000001000000003000000415f35aaf21479ace0d673fe8ed3dc2bcca1fbc200000000ffff0300504b0304140000080800298efb548a8d85c62c0000002000000005000000525f345f31002000dfff7d7398f16ca83ae6e66ab84b35199f1aedebf8c9efd0a4d5b5123e1eee281fa8000000ffff0300504b0304140000080800298efb5431a1ece119000000100000000400000041545f343a64ffe932cb3df9990185523f9ade3d1005000000ffff0300504b01021400140000080800298efb5436623b130d00000005000000050000000000000000000000000000000000525f315f31504b01021400140000080800298efb542ac491b8190000001000000004000000000000000000000000003000000041545f31504b01021400140000080800298efb5414fabdcf0c0000000400000005000000000000000000000000006b000000525f335f31504b01021400140000080800298efb54edf67d87190000001000000004000000000000000000000000009a00000041545f33504b01021400140000080800298efb5463b2ceb640020000c70300000500000000000000000000000000d5000000525f325f31504b01021400140000080800298efb549ef5ca35190000001000000004000000000000000000000000003803000041545f32504b01021400140000080800298efb54cbead83b1900000010000000050000000000000000000000000073030000525f355f31504b01021400140000080800298efb5485cc067519000000100000000300000000000000000000000000af030000415f35504b01021400140000080800298efb548a8d85c62c000000200000000500000000000000000000000000e9030000525f345f31504b01021400140000080800298efb5431a1ece1190000001000000004000000000000000000000000003804000041545f34504b0506000000000a000a00f8010000730400000000
//
        final var b64EphemeralPublicKey= "MIIBdTCCAR0GByqGSM49AgEwggEQAgEBMDQGByqGSM49AQECKQDTXkcgNrxPt+E8eF7SAeBl+Y/Ppvb0De9PkrnseJPsKPzUErHxsy4nMFQEKD7jC1aPurD4g8zr1G0/O7iipzUT9et52mYZDrCF/6n0kvN1qX2GDrQEKFIIg5Sd/bxC060ZhkBoim/hP0E0lVS0mswx3M2IRTmBb160rI+x8aYEUQRDvX6a+1PYuFKJvMSO5b/m8gE30QoIfrbnhx4qEKWZxxCvjQ054gYRFP3QVUXsHMirQJMkf3cnXgdD/+0RcYLqqcd4d6qsasfTUkXRaS6O4QIpANNeRyA2vE+34Tx4XtIB4GX5j8+lto8Soy1ILsfuhljphpFVW0TFkxECAQEDUgAEvj5W85oNciW3tK/iCPhe0XXtMLnmB2jOILjQJKKHRReERjD34YZt43/hV90kW6UYL/xrvOPo+UxKIFcxv4+6ZBoCIruFyN3xAK3cY3n5e8o=";
        final var b64WrappedCommand= "DLCOAA2XAUCOCI/myuvINIlWAA==";
        final var b64WrappedResponse= "h1EB4VMLY2nwnY9ma88+STo0jDtjelX+99e/c1cMu7sQ1SUICMYNXI2S6Q++UeKpbMjIEQkBZhPtVgMNNFBokU1AnzieM1YVQsmUYjLlSC0KUdKZApAAjggrl2uu1Trs4pAA";

        final var hexPublicKey = Hex.toHexString(Base64.decode(b64EphemeralPublicKey));
        final var hexExpectedCommand = Hex.toHexString(Base64.decode(b64WrappedCommand));
        final var hexExpectedWrappedRbResult = Hex.toHexString(Base64.decode(b64WrappedResponse));

        try
        {
            //Setup MessageCipherInfo
            final var mca = new MessageCipherInfo();
            //Dont need iv
            final var rdeInfo = new RdeMessageDecryptionInfo();
            rdeInfo.setCommand(hexExpectedCommand);
            rdeInfo.setDocumentDisplayName("SPEC2014");
            rdeInfo.setPcdPublicKey(hexPublicKey);
            mca.setRdeInfo(rdeInfo);

            final var response = getApduResponseForDecryption(SPEC2014BacKey, tag, mca);

            var hexActualRbWrappedResult = Hex.toHexString(response);

            System.out.println("EXPECTED Response  :" + hexExpectedWrappedRbResult);
            System.out.println("ACTUAL   Response  :" + hexActualRbWrappedResult);

            if (hexExpectedWrappedRbResult.equals(hexActualRbWrappedResult))
                System.out.println(">>>> PASS");
            else
                System.out.println("FAIL!");
        }
        catch (GeneralSecurityException e)
        {
            e.printStackTrace();
        }
        catch (IOException e)
        {
            e.printStackTrace();
        }
        catch (CardServiceException e)
        {
            e.printStackTrace();
        }
        catch (GeneralRdeException e)
        {
            e.printStackTrace();
        }
    }

    private static byte[] getApduResponseForDecryption(final BACKey bacKey, final Tag tag, final MessageCipherInfo mca) throws IOException, CardServiceException, GeneralSecurityException, GeneralRdeException {
        byte[] dg14content;
        try (final var doc = new AndroidRdeDocument()) {
            doc.open(tag, bacKey);
            dg14content = doc.getFileContent(14);
        }
        try (final var doc = new AndroidRdeDocument())
        {
            doc.open(tag, bacKey);
            return doc.getApduResponseForDecryption(mca, dg14content);
        }
    }

    @Override
    protected void onResume()
    {
        super.onResume();

        var nfcAdapter = NfcAdapter.getDefaultAdapter(getApplicationContext());
        if (nfcAdapter == null)
            // nfc not available on the device
            return;

        if (!nfcAdapter.isEnabled())
        {
            nfcSettingsLauncher.launch(new Intent(Settings.ACTION_NFC_SETTINGS));
            return;
        }

        var intent = new Intent(getApplicationContext(), TestRdeDecryptionActivity.class);
        intent.setFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP);
        var pendingIntent = PendingIntent.getActivity(this, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT);
        nfcAdapter.enableForegroundDispatch(this, pendingIntent, null, new String[][]{new String[]{"android.nfc.tech.IsoDep"}});
    }
}